<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simple Coordinate Picker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
    }
    .controls {
      background: #f0f0f0;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 5px;
    }
    .controls input {
      padding: 8px;
      margin: 5px;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
    .search-container {
      display: flex;
      gap: 5px;
      margin-top: 10px;
      position: relative;
    }
    .search-container input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
    .search-container button {
      padding: 8px 15px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    .search-container button:hover {
      background: #0056b3;
    }
    .search-status {
      margin-top: 5px;
      font-size: 12px;
      color: #666;
      display: none;
    }
    .search-status.active {
      display: block;
      color: #28a745;
    }
    .reset-button {
      padding: 4px 8px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 11px;
      margin-left: 5px;
    }
    .reset-button:hover {
      background: #c82333;
    }
    .location-button {
      padding: 8px 15px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      margin-left: 10px;
    }
    .location-button:hover {
      background: #218838;
    }
    .location-button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 50px;
      background: white;
      border: 1px solid #ccc;
      border-top: none;
      border-radius: 0 0 3px 3px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }
    .search-result-item {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    .search-result-item:hover {
      background: #f0f0f0;
    }
    .search-result-item:last-child {
      border-bottom: none;
    }
    .search-result-name {
      font-weight: bold;
      color: #333;
    }
    .search-result-address {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }
    .error-message {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      padding: 8px;
      border-radius: 3px;
      margin: 5px 0;
      font-size: 12px;
    }
    .loading-message {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      padding: 8px;
      border-radius: 3px;
      margin: 5px 0;
      font-size: 12px;
    }
    .error-message {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      padding: 8px;
      border-radius: 3px;
      margin: 5px 0;
      font-size: 12px;
    }
    .loading-message {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      padding: 8px;
      border-radius: 3px;
      margin: 5px 0;
      font-size: 12px;
    }
    #map {
      height: 70vh;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div class="controls">
    <h3>Coordinate Picker</h3>
    <input type="number" id="lat" placeholder="Latitude" step="any" value="-6.9175">
    <input type="number" id="lng" placeholder="Longitude" step="any" value="107.6191">
    <button class="location-button" onclick="useMyLocation()" id="locationBtn">üìç Gunakan Lokasi Saya</button>
    
    <div class="search-container">
      <input type="text" id="searchInput" placeholder="Cari lokasi (contoh: Gedung Sate Bandung)">
      <div id="searchResults" class="search-results"></div>
    </div>
    <div id="searchStatus" class="search-status">
      üèõÔ∏è Pencarian difokuskan di sekitar: <span id="kecamatanName"></span>
      <button class="reset-button" onclick="resetToGlobalSearch()">Reset ke Global</button>
    </div>
  </div>
  
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let map;
    let marker;
    
    // Variables for hierarchical search
    let referenceCoords = null; // Store kecamatan coordinates
    let isKecamatanSelected = false; // Flag to track if kecamatan is selected
    let searchRadius = 20; // Search radius in km

    // Initialize map at Alun-alun Bandung
    map = L.map('map').setView([-6.9175, 107.6191], 15);
    
    // Add satellite tiles
    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Satellite imagery'
    }).addTo(map);

    // Add default OpenStreetMap layer
    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    // Add labels layer (street names, buildings, etc.) on top of satellite
    const labelsLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      pane: 'shadowPane'
    }).addTo(map);

    // Alternative: Add OpenStreetMap labels (more detailed street names)
    const osmLabelsLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      opacity: 0.6  // Make it semi-transparent to show satellite underneath
    });

    // Layer control to toggle between different label options
    const baseLayers = {
      "Satellite": satelliteLayer,
      "OpenStreetMap": osmLayer
    };
    
    const overlayLayers = {
      "Street Names & Labels": labelsLayer,
      "OpenStreetMap Overlay": osmLabelsLayer
    };

    L.control.layers(baseLayers, overlayLayers).addTo(map);

    // Add marker at Alun-alun Bandung
    marker = L.marker([-6.9175, 107.6191]).addTo(map);

    // Click on map to move marker
    map.on('click', function(e) {
      try {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        
        // Validate coordinates
        if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
          console.error('Invalid coordinates from map click:', lat, lng);
          return;
        }
        
        // Move marker to clicked location
        marker.setLatLng([lat, lng]);
        
        // Update input fields
        document.getElementById('lat').value = lat.toFixed(6);
        document.getElementById('lng').value = lng.toFixed(6);
      } catch (error) {
        console.error('Error handling map click:', error);
      }
    });

    // Hierarchical search function
    async function searchLocation() {
      const query = document.getElementById('searchInput').value.trim();
      const resultsDiv = document.getElementById('searchResults');
      
      if (!query) {
        showError('Masukkan nama lokasi untuk dicari', resultsDiv);
        return;
      }
      
      if (query.length < 2) {
        showError('Masukkan minimal 2 karakter untuk pencarian', resultsDiv);
        return;
      }
      
      try {
        // Show loading
        showLoading('Mencari lokasi...', resultsDiv);
        
        let searchResults = [];
        
        // Step 1: If kecamatan is selected, try local search first
        if (isKecamatanSelected && referenceCoords) {
          console.log('Searching locally around kecamatan...');
          try {
            searchResults = await performLocalSearch(query);
            
            if (searchResults.length === 0) {
              console.log('No local results, falling back to global search...');
              showLoading('Tidak ditemukan di sekitar kecamatan, mencari secara global...', resultsDiv);
              searchResults = await performGlobalSearch(query);
            }
          } catch (localError) {
            console.warn('Local search failed, trying global search:', localError);
            showLoading('Pencarian lokal gagal, mencari secara global...', resultsDiv);
            searchResults = await performGlobalSearch(query);
          }
        } else {
          // Step 2: Global search (check if it's a kecamatan first)
          console.log('Performing global search...');
          searchResults = await performGlobalSearch(query);
        }
        
        displaySearchResults(searchResults, resultsDiv);
        
      } catch (error) {
        console.error('Search error:', error);
        
        let errorMessage = 'Terjadi kesalahan saat mencari lokasi. ';
        
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          errorMessage += 'Periksa koneksi internet Anda.';
        } else if (error.name === 'AbortError') {
          errorMessage += 'Pencarian dibatalkan karena timeout.';
        } else if (error.message.includes('rate limit')) {
          errorMessage += 'Terlalu banyak pencarian. Coba lagi dalam beberapa detik.';
        } else {
          errorMessage += 'Silakan coba lagi.';
        }
        
        showError(errorMessage, resultsDiv);
      }
    }
    
    // Local search within radius of kecamatan
    async function performLocalSearch(query) {
      const lat = referenceCoords.lat;
      const lng = referenceCoords.lng;
      
      // Validate coordinates
      if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
        throw new Error('Invalid reference coordinates');
      }
      
      // Calculate bounding box (approximately searchRadius km)
      const latDelta = searchRadius / 111; // roughly 1 degree = 111km
      const lngDelta = searchRadius / (111 * Math.cos(lat * Math.PI / 180));
      
      const bbox = [
        lng - lngDelta, // west
        lat - latDelta, // south
        lng + lngDelta, // east
        lat + latDelta  // north
      ].join(',');
      
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&bounded=1&viewbox=${bbox}&limit=10`;
      
      // Create abort controller for timeout
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 8000); // 8 second timeout
      
      try {
        const response = await fetch(url, {
          signal: controller.signal,
          headers: {
            'User-Agent': 'LeafletMapApp/1.0'
          }
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          if (response.status === 429) {
            throw new Error('Rate limit exceeded');
          }
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!Array.isArray(data)) {
          throw new Error('Invalid response format');
        }
        
        return data;
      } catch (error) {
        clearTimeout(timeoutId);
        if (error.name === 'AbortError') {
          throw new Error('Local search timeout');
        }
        throw error;
      }
    }
    
    // Global search
    async function performGlobalSearch(query) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=10`;
      
      // Create abort controller for timeout
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
      
      try {
        const response = await fetch(url, {
          signal: controller.signal,
          headers: {
            'User-Agent': 'LeafletMapApp/1.0'
          }
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          if (response.status === 429) {
            throw new Error('Rate limit exceeded');
          }
          if (response.status >= 500) {
            throw new Error('Server error, please try again later');
          }
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!Array.isArray(data)) {
          throw new Error('Invalid response format');
        }
        
        return data;
      } catch (error) {
        clearTimeout(timeoutId);
        if (error.name === 'AbortError') {
          throw new Error('Search timeout - please try again');
        }
        throw error;
      }
    }
    
    // Display search results
    function displaySearchResults(data, resultsDiv) {
      try {
        if (!data || !Array.isArray(data)) {
          showError('Format data hasil pencarian tidak valid', resultsDiv);
          return;
        }
        
        if (data.length > 0) {
          resultsDiv.innerHTML = '';
          
          data.forEach((location, index) => {
            // Skip invalid locations
            if (!location || !location.lat || !location.lon || !location.display_name) {
              console.warn('Skipping invalid location data:', location);
              return;
            }
            
            const item = document.createElement('div');
            item.className = 'search-result-item';
            
            // Extract location name and check if it's a kecamatan
            const locationName = location.display_name.split(',')[0];
            const isKecamatan = location.display_name.toLowerCase().includes('kecamatan') || 
                               location.type === 'administrative' || 
                               location.class === 'place';
            
            // Add indicator for kecamatan
            const indicator = isKecamatan ? ' üèõÔ∏è' : '';
            
            item.innerHTML = `
              <div class="search-result-name">${locationName}${indicator}</div>
              <div class="search-result-address">${location.display_name}</div>
            `;
            
            // Add click handler with error handling
            item.onclick = () => {
              try {
                selectLocation(location, isKecamatan);
              } catch (error) {
                console.error('Error in item click handler:', error);
                showError('Terjadi kesalahan saat memilih lokasi', resultsDiv);
              }
            };
            
            resultsDiv.appendChild(item);
          });
          
          resultsDiv.style.display = 'block';
        } else {
          const message = isKecamatanSelected ? 
            'Tidak ditemukan di sekitar kecamatan ini. Coba dengan kata kunci yang berbeda.' :
            'Lokasi tidak ditemukan';
          resultsDiv.innerHTML = `<div class="search-result-item">${message}</div>`;
          resultsDiv.style.display = 'block';
        }
      } catch (error) {
        console.error('Error displaying search results:', error);
        showError('Terjadi kesalahan saat menampilkan hasil pencarian', resultsDiv);
      }
    }
    
    // Function to select a location from dropdown
    function selectLocation(location, isKecamatan = false) {
      try {
        if (!location || !location.lat || !location.lon) {
          throw new Error('Invalid location data');
        }
        
        const lat = parseFloat(location.lat);
        const lng = parseFloat(location.lon);
        
        // Validate coordinates
        if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
          throw new Error('Invalid coordinates');
        }
        
        // Move map and marker to selected location
        const zoomLevel = isKecamatan ? 14 : 16; // Zoom out more for kecamatan
        map.setView([lat, lng], zoomLevel);
        marker.setLatLng([lat, lng]);
        
        // Update input fields
        document.getElementById('lat').value = lat.toFixed(6);
        document.getElementById('lng').value = lng.toFixed(6);
        
        // Update search input with selected location name
        const locationName = location.display_name ? location.display_name.split(',')[0] : 'Unknown Location';
        document.getElementById('searchInput').value = locationName;
        
        // If kecamatan is selected, set as reference point
        if (isKecamatan) {
          referenceCoords = { lat, lng };
          isKecamatanSelected = true;
          console.log(`Kecamatan selected: ${locationName} at ${lat}, ${lng}`);
          console.log(`Future searches will prioritize ${searchRadius}km radius around this point`);
          
          // Update placeholder to indicate local search is active
          document.getElementById('searchInput').placeholder = `Cari di sekitar ${locationName} (atau lokasi lain)`;
          
          // Show status indicator
          document.getElementById('kecamatanName').textContent = locationName;
          document.getElementById('searchStatus').classList.add('active');
        }
        
        // Hide dropdown
        document.getElementById('searchResults').style.display = 'none';
        
      } catch (error) {
        console.error('Error selecting location:', error);
        alert('Terjadi kesalahan saat memilih lokasi. Silakan coba lagi.');
      }
    }
    
    // Reset to global search
    function resetToGlobalSearch() {
      referenceCoords = null;
      isKecamatanSelected = false;
      
      // Reset UI
      document.getElementById('searchInput').placeholder = 'Cari lokasi (contoh: Gedung Sate Bandung)';
      document.getElementById('searchStatus').classList.remove('active');
      document.getElementById('searchResults').style.display = 'none';
      
      console.log('Reset to global search mode');
    }
    
    // Helper functions for user feedback
    function showError(message, container) {
      if (!container) {
        console.error('Container element not found for error message:', message);
        return;
      }
      container.innerHTML = `<div class="search-result-item error-message">${message}</div>`;
      container.style.display = 'block';
    }
    
    function showLoading(message, container) {
      if (!container) {
        console.error('Container element not found for loading message:', message);
        return;
      }
      container.innerHTML = `<div class="search-result-item loading-message">${message}</div>`;
      container.style.display = 'block';
    }
    
    // Use current location
    function useMyLocation() {
      const locationBtn = document.getElementById('locationBtn');
      
      if (!navigator.geolocation) {
        alert('Geolocation tidak didukung oleh browser ini.');
        return;
      }
      
      // Disable button and show loading
      locationBtn.disabled = true;
      locationBtn.textContent = 'üìç Mengambil lokasi...';
      
      navigator.geolocation.getCurrentPosition(
        function(position) {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          const accuracy = position.coords.accuracy;
          
          // Move map and marker to current location
          map.setView([lat, lng], 16);
          marker.setLatLng([lat, lng]);
          
          // Update input fields
          document.getElementById('lat').value = lat.toFixed(6);
          document.getElementById('lng').value = lng.toFixed(6);
          
          // Reset search input
          document.getElementById('searchInput').value = '';
          document.getElementById('searchInput').placeholder = 'Cari lokasi (contoh: Gedung Sate Bandung)';
          
          // Reset hierarchical search
          resetToGlobalSearch();
          
          // Show success message
          console.log(`Current location: ${lat}, ${lng} (accuracy: ${accuracy}m)`);
          
          // Re-enable button
          locationBtn.disabled = false;
          locationBtn.textContent = 'üìç Gunakan Lokasi Saya';
        },
        function(error) {
          let errorMessage = 'Tidak dapat mengambil lokasi. ';
          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMessage += 'Izin lokasi ditolak.';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMessage += 'Informasi lokasi tidak tersedia.';
              break;
            case error.TIMEOUT:
              errorMessage += 'Timeout saat mengambil lokasi.';
              break;
            default:
              errorMessage += 'Terjadi kesalahan yang tidak diketahui.';
              break;
          }
          
          alert(errorMessage);
          console.error('Geolocation error:', error);
          
          // Re-enable button
          locationBtn.disabled = false;
          locationBtn.textContent = 'üìç Gunakan Lokasi Saya';
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 60000
        }
      );
    }
    
    // Hide dropdown when clicking outside
    document.addEventListener('click', function(event) {
      try {
        const searchContainer = event.target.closest('.search-container');
        if (!searchContainer) {
          document.getElementById('searchResults').style.display = 'none';
        }
      } catch (error) {
        console.error('Error in click outside handler:', error);
      }
    });
    
    // Allow search on Enter key
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
      try {
        if (e.key === 'Enter') {
          searchLocation();
        }
      } catch (error) {
        console.error('Error in keypress handler:', error);
      }
    });
    
    // Auto search while typing (with debounce)
    let searchTimeout;
    document.getElementById('searchInput').addEventListener('input', function(e) {
      try {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();
        
        if (query.length >= 3) {
          searchTimeout = setTimeout(() => {
            try {
              searchLocation();
            } catch (error) {
              console.error('Error in debounced search:', error);
            }
          }, 500); // Wait 500ms after user stops typing
        } else {
          document.getElementById('searchResults').style.display = 'none';
        }
      } catch (error) {
        console.error('Error in input handler:', error);
      }
    });
  </script>
</body>
</html>